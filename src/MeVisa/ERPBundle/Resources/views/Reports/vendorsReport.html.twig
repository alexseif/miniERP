{% extends ':default:admin.html.twig' %}
{% block title %}{{ (vendor? vendor.name : "NO VENDOR") }} Report for {{ month }} {{ year }} {% endblock %}
{% block stylesheets %}
  {{ parent() }}
  <link rel="stylesheet" type="text/css" href="/css/dataTables.bootstrap.min.css" />
  <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/buttons/1.1.2/css/buttons.dataTables.min.css"/>
  <style type="text/css">
    table.dataTable{margin: 0 !important;}
    div.dataTables_wrapper div.dataTables_paginate{text-align: center;}
  </style>
{% endblock %}
{% block wrapper %}
  <div class="container-fluid">
    <a class="btn btn-default ml-5" href="{{ path('reports_vendors') }}"><span class="glyphicon glyphicon-arrow-left"></span></a>
    <strong>{{ (vendor? vendor.name : "NO VENDOR") }}</strong> Report for <strong>{{ month }} {{ year }} </strong>
    <hr/>
    <table class="table table-condensed records_list" id="datatable" cellspacing="0">
      <thead>
        <tr>
          <th>Заявка #</th>
          <th>Date</th>
          <th>Покупатель</th>
          <th>Vendor</th>
          <th>Подзаявка (№,  направление, поставщик)</th>
          <th>PAX</th>
          <th>Companions</th>
          <th>Стоимость</th>
          <th>Себетоимость</th>
          <th>Оплачено покупателем</th>
        </tr>
      </thead>
      <tbody>
        {% set pax = 0 %}
        {% set tcost = 0 %}
        {% set tprice = 0 %}
        {% set tpay = 0 %}
        {% for order in orders %}
          {% set pax = pax + order.people %}
          {% set tpay = tpay + order.orderPayments|last.amount %}
          <tr>
            <td><a class="btn btn-link" href="{{ path('orders_show', { 'id': order.id }) }}">{{ order.number }}</a></td>
            <td>{{order.createdAt|localizeddate('short', 'none')}}</td>
            <td>{{ order.customer.name }}</td>
            <td>
              {% set br = '' %}
              {% for op in order.orderProducts %}
                {{ (op.vendor)? op.vendor.name}} 
                {% set br = '\n' %}
              {% endfor %}
            </td>
            <td>
              {% set br = '' %}
              {% set cost = 0 %}
              {% set price = 0 %}
              {% for op in order.orderProducts %}
                {% set cost = cost + (op.quantity * op.unitCost) %}
                {% set price = price + op.total %}
                {{ br|nl2br }} {{ op.quantity }} {{ op.product.name }} {{ (op.vendor)? op.vendor.name}} 
                {% set br = '\n' %}
              {% endfor %}
              {% set tcost = tcost + cost %}
              {% set tprice = tprice + price %}
            </td>
            <td>{{ order.people }}</td>
            <td style="padding: 4px 0px;">
              <table class="table table-condensed table-bordered" style="margin: 0px;">
                {% for oc in order.orderCompanions %}
                  <tr><td>{{ oc.name }}</td></tr>
                {% endfor %}
              </table>
            </td>
            <td>{{ (cost/100)|number_format }}</td>
            <td>{{ (price/100)|number_format }}</td>
            <td>{{ ((order.orderPayments|last.amount)/100)|number_format }}</td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th></th>
          <th>{{pax}}</th>
          <th></th>
          <th>{{tcost|number_format(2, '.', ',') }}</th>
          <th>{{tprice|number_format(2, '.', ',') }}</th>
          <th>{{tpay|number_format(2, '.', ',') }}</th>
        </tr>
      </tfoot>
    </table>
  </div>
{% endblock %}
{% block javascripts %}
  {{ parent() }}
  <script src="/js/datatables.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/1.1.2/js/dataTables.buttons.min.js"></script>
  <script src="//cdn.datatables.net/buttons/1.1.2/js/buttons.flash.min.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>
  <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/pdfmake.min.js"></script>
  <script src="//cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
  <script src="//cdn.datatables.net/buttons/1.1.2/js/buttons.html5.min.js"></script>
  <script src="//cdn.datatables.net/buttons/1.1.2/js/buttons.print.min.js "></script>
  <script type="text/javascript">
    $(document).ready(function () {
      $('#datatable').DataTable({
        dom: "<'row'<'col-sm-8'B><'col-sm-2 text-right'l><'col-sm-2'f>>tip",
        buttons: [
          'copy', 'csv', 'excel', 'pdf', 'print'
        ]
      });
    });
  </script>

{% endblock %}